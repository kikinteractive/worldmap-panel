{"version":3,"sources":["../src/data_formatter.js"],"names":["_","decodeGeoHash","DataFormatter","ctrl","kbn","data","series","length","highestValue","lowestValue","Number","MAX_VALUE","forEach","serie","lastPoint","last","datapoints","lastValue","isArray","location","find","locations","loc","key","toUpperCase","alias","isString","push","value","valueFormatted","valueRounded","dataValue","locationName","name","locationLatitude","latitude","locationLongitude","longitude","stats","panel","valueName","roundValue","parseInt","decimals","valueRange","dataList","esGeoPoint","esMetric","isPrometheus","datasource","datapoint","encodedGeohash","target","decodedGeohash","metricValue","unitSingular","unitPlural","esLocationName","tableData","geohash","tableLabel","metric","type","columnNames","columns","column","columnIndex","text","rows","row"],"mappings":"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","file":"data_formatter.js","sourcesContent":["import _ from 'lodash';\nimport decodeGeoHash from './geohash';\n\nexport default class DataFormatter {\n  constructor(ctrl, kbn) {\n    this.ctrl = ctrl;\n    this.kbn = kbn;\n  }\n\n  setValues(data) {\n    if (this.ctrl.series && this.ctrl.series.length > 0) {\n      let highestValue = 0;\n      let lowestValue = Number.MAX_VALUE;\n\n      this.ctrl.series.forEach((serie) => {\n        const lastPoint = _.last(serie.datapoints);\n        const lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\n        const location = _.find(this.ctrl.locations, (loc) => { return loc.key.toUpperCase() === serie.alias.toUpperCase(); });\n\n        if (!location) return;\n\n        if (_.isString(lastValue)) {\n          data.push({key: serie.alias, value: 0, valueFormatted: lastValue, valueRounded: 0});\n        } else {\n          const dataValue = {\n            key: serie.alias,\n            locationName: location.name,\n            locationLatitude: location.latitude,\n            locationLongitude: location.longitude,\n            value: serie.stats[this.ctrl.panel.valueName],\n            valueFormatted: lastValue,\n            valueRounded: 0\n          };\n\n          if (dataValue.value > highestValue) highestValue = dataValue.value;\n          if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n          dataValue.valueRounded = this.kbn.roundValue(dataValue.value, parseInt(this.ctrl.panel.decimals, 10) || 0);\n          data.push(dataValue);\n        }\n      });\n\n      data.highestValue = highestValue;\n      data.lowestValue = lowestValue;\n      data.valueRange = highestValue - lowestValue;\n    }\n  }\n\n  setGeohashValues(dataList, data) {\n    if (!this.ctrl.panel.esGeoPoint || !this.ctrl.panel.esMetric) return;\n\n    if (dataList && dataList.length > 0) {\n      //Prometheus' returned results have a different structure than ElasticSearch.\n      //The shape is approximately: \n      //dataList = [ \n      //             { \n      //               target=\"someGeoHash\", \n      //               datapoints = [ \n      //                               [0=metric, 1=ticks],\n      //                               ...\n      //                            ] \n      //             } \n      //           ]\n      //For now, just take the latest datapoint for each geohash, since we aren't displaying\n      //the full time series on the map, and we just want the current value.\n      let isPrometheus = this.ctrl.panel.datasource == \"prometheus\";\n      if(isPrometheus) {\n        let highestValue = 0;\n        let lowestValue = Number.MAX_VALUE;\n\n        dataList.forEach((datapoint) => {\n          const encodedGeohash = datapoint.target;\n          const decodedGeohash = decodedGeohash(encodedGeohash);\n          const metricValue = datapoint.datapoints.last()[0];\n\n          const dataValue = {\n            key: encodedGeohash,\n            locationName: encodedGeohash,\n            locationLatitude: decodedGeohash.latitude,\n            locationLongitude: decodedGeohash.longitude,\n            value: metricValue,//0 is the actual metric value\n            valueFormatted: metricValue + (metricValue == 1 ? this.ctrl.panel.unitSingular : this.ctrl.panel.unitPlural),\n            valueRounded: this.kbn.roundValue(metricValue, this.ctrl.panel.decimals || 0)\n          };\n\n          if (dataValue.value > highestValue) highestValue = dataValue.value;\n          if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n          data.push(dataValue);\n        });\n\n        data.highestValue = highestValue;\n        data.lowestValue = lowestValue;\n        data.valueRange = highestValue - lowestValue;\n      }\n      else {//Not Prometheus; proceed as normal.\n        let highestValue = 0;\n        let lowestValue = Number.MAX_VALUE;\n\n        dataList[0].datapoints.forEach((datapoint) => {\n          const encodedGeohash = datapoint[this.ctrl.panel.esGeoPoint];\n          const decodedGeohash = decodeGeoHash(encodedGeohash);\n\n          const dataValue = {\n            key: encodedGeohash,\n            locationName: this.ctrl.panel.esLocationName ? datapoint[this.ctrl.panel.esLocationName] : encodedGeohash,\n            locationLatitude: decodedGeohash.latitude,\n            locationLongitude: decodedGeohash.longitude,\n            value: datapoint[this.ctrl.panel.esMetric],\n            valueFormatted: datapoint[this.ctrl.panel.esMetric],\n            valueRounded: 0\n          };\n\n          if (dataValue.value > highestValue) highestValue = dataValue.value;\n          if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n          dataValue.valueRounded = this.kbn.roundValue(dataValue.value, this.ctrl.panel.decimals || 0);\n          data.push(dataValue);\n        });\n\n        data.highestValue = highestValue;\n        data.lowestValue = lowestValue;\n        data.valueRange = highestValue - lowestValue;\n      }\n    }\n  }\n\n  static tableHandler(tableData) {\n    const datapoints = [];\n\n    if (tableData.type === 'table') {\n      const columnNames = {};\n\n      tableData.columns.forEach((column, columnIndex) => {\n        columnNames[columnIndex] = column.text;\n      });\n\n      tableData.rows.forEach((row) => {\n        const datapoint = {};\n\n        row.forEach((value, columnIndex) => {\n          const key = columnNames[columnIndex];\n          datapoint[key] = value;\n        });\n\n        datapoints.push(datapoint);\n      });\n    }\n\n    return datapoints;\n  }\n\n  setTableValues(tableData, data) {\n    if (tableData && tableData.length > 0) {\n      let highestValue = 0;\n      let lowestValue = Number.MAX_VALUE;\n\n      tableData[0].forEach((datapoint) => {\n        if (!datapoint.geohash) {\n          return;\n        }\n\n        const encodedGeohash = datapoint.geohash;\n        const decodedGeohash = decodeGeoHash(encodedGeohash);\n\n        const dataValue = {\n          key: encodedGeohash,\n          locationName: datapoint[this.ctrl.panel.tableLabel] || 'n/a',\n          locationLatitude: decodedGeohash.latitude,\n          locationLongitude: decodedGeohash.longitude,\n          value: datapoint.metric,\n          valueFormatted: datapoint.metric,\n          valueRounded: 0\n        };\n\n        if (dataValue.value > highestValue) highestValue = dataValue.value;\n        if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n        dataValue.valueRounded = this.kbn.roundValue(dataValue.value, this.ctrl.panel.decimals || 0);\n        data.push(dataValue);\n      });\n\n      data.highestValue = highestValue;\n      data.lowestValue = lowestValue;\n      data.valueRange = highestValue - lowestValue;\n    }\n  }\n}"]}